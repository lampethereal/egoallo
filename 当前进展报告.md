# EgoAllo与UniEgoMotion对比项目 - 当前进展报告

## 📊 已完成工作

### ✅ 1. UniEgoMotion完整工具链（已完成）

**文件**:
- `一键推理.py` - 自动化推理脚本
- `查看可用序列.py` - 序列浏览工具
- 数据说明文档系列

**能力**:
- ✓ 在EE4D数据上一键推理
- ✓ 自动生成可视化视频
- ✓ 灵活的序列选择（first/random/specific）
- ✓ 清晰的配置管理

### ✅ 2. EgoAllo代码分析（已完成）

**理解的关键信息**:

| 维度 | 详情 |
|------|------|
| **输入格式** | `Ts_world_cpf [T+1, 7]` - wxyz四元数 + xyz平移 |
| **网络输入** | 相对变换 `T_cpf_tm1_cpf_t [T, 6]` - 切空间表示 |
| **输出格式** | `EgoDenoiseTraj` - SMPL-H参数（21身体+15×2手） |
| **推理流程** | 扩散采样 + 可选Guidance优化（HaMeR手部） |
| **保存格式** | NPZ文件，包含轨迹、四元数、betas等 |

**关键文件**:
- `3_aria_inference.py` - 推理脚本
- `src/egoallo/sampling.py` - 扩散采样
- `src/egoallo/network.py` - 模型定义
- `src/egoallo/inference_utils.py` - 加载工具

### ✅ 3. 数据转换工具（已完成）

**文件**: `ee4d_to_egoallo_简化版.py`

**功能**:
- ✓ EE4D aria_traj `[T, 9]` → EgoAllo Ts_world_cpf `[T+1, 7]`
- ✓ rotation_6d → 四元数转换（数值稳定）
- ✓ 地面高度调整
- ✓ T0帧外推估计
- ✓ 纯PyTorch实现，无外部依赖

**验证结果**:
```
四元数范数偏差: max=1.19e-07  ✓
旋转还原误差: max=5.96e-07   ✓
```

### ✅ 4. 文档体系（已完成）

1. **EgoAllo数据格式说明.md** - 详细的数据格式对比
2. **一键推理使用说明.md** - 实施策略和建议
3. **当前进展报告.md** (本文件)

---

## 🚧 核心挑战分析

### 挑战1：环境依赖

**EgoAllo依赖**:
```
Python >=3.12
projectaria_tools==1.6.0  ← 主要问题
JAX (CUDA)
```

**问题**: `projectaria_tools`在当前环境安装失败

**影响**: 无法直接运行EgoAllo的原生推理脚本

### 挑战2：数据格式差异

| 特性 | EE4D/UniEgoMotion | EgoAllo |
|------|-------------------|---------|
| 频率 | 10 FPS | 30 FPS |
| 窗口 | 80帧(8秒) | 128帧(4.27秒) |
| 长度 | T帧 | T+1帧 |
| 旋转 | rotation_6d | 四元数 |
| SMPL | SMPL-X | SMPL-H |

**已解决**: ✓ rotation_6d ↔ 四元数转换  
**待处理**: 频率统一、窗口适配

### 挑战3：推理流程差异

**UniEgoMotion**:
```
aria_traj [T,9] → 归一化 → Diffusion → 反归一化 → SMPL-X
```

**EgoAllo**:
```
Ts_world_cpf [T+1,7] → 相对变换 → Diffusion → (Guidance) → SMPL-H
```

**关键差异**: 
- EgoAllo需要计算相对变换（需要T+1帧）
- EgoAllo训练时不用图像，推理时可选HaMeR

---

## 🎯 可行方案

### 方案A：务实方案（推荐，短期可行）

**策略**: 先专注于UniEgoMotion的完整评估

**理由**:
1. UniEgoMotion环境已就绪 ✓
2. 工具链已完善 ✓
3. 可以立即产出结果

**行动计划**:
1. 在多条EE4D数据上运行UniEgoMotion
2. 生成定性结果（可视化视频）
3. 如果有GT，计算定量指标（MPJPE）
4. 整理结果报告

**优点**:
- 无阻塞，立即可执行
- 可以先验证数据质量
- 为后续对比建立baseline

### 方案B：完整对比方案（长期目标）

**策略**: 解决EgoAllo环境，实现真正对比

**步骤**:

#### 阶段1：环境准备
```bash
# 创建新的Python 3.12环境
conda create -n egoallo python=3.12
conda activate egoallo

# 安装依赖（可能需要从源码编译projectaria_tools）
pip install torch jax[cuda12]
# 处理projectaria_tools安装问题
```

#### 阶段2：适配EE4D数据

创建"伪Aria数据结构"，绕过VRS/MPS加载：

```python
# 新文件：egoallo_ee4d_adapter.py

class EE4DDataAdapter:
    """让EgoAllo能够处理EE4D数据"""
    
    @staticmethod
    def prepare_inference_input(ee4d_sequence):
        # 1. 加载EE4D数据
        aria_traj = load_ee4d_data(seq_name)  # [T, 9]
        
        # 2. 转换格式
        Ts_world_cpf = ee4d_aria_traj_to_egoallo(aria_traj)  # [T+1, 7]
        
        # 3. 创建伪数据结构
        return {
            "Ts_world_cpf": Ts_world_cpf,
            "floor_z": floor_height,
            "hamer_detections": None,  # 暂不使用
            "aria_detections": None,
        }
    
    @staticmethod
    def run_egoallo_inference(data_dict):
        # 调用EgoAllo推理，绕过VRS加载
        ...
```

#### 阶段3：统一评估

```python
# 新文件：dual_model_comparison.py

def compare_models(sequence_list):
    results = []
    
    for seq_name in sequence_list:
        # UniEgoMotion推理
        uem_result = run_uniegomotion(seq_name)
        
        # EgoAllo推理
        egoallo_result = run_egoallo_adapted(seq_name)
        
        # 统一格式并计算指标
        metrics = compute_metrics(uem_result, egoallo_result, gt)
        results.append(metrics)
    
    # 生成对比报告
    generate_comparison_report(results)
```

---

## 💡 推荐行动方案

基于当前情况，我建议**分两步走**：

### 第一步：立即执行（1-2天）

✅ **专注UniEgoMotion验证**

1. 选择5-10条有代表性的EE4D序列
   ```python
   python 查看可用序列.py --recommend
   ```

2. 批量推理
   ```python
   # 编写批量脚本
   for seq in selected_sequences:
       python 一键推理.py --sequence seq
   ```

3. 整理结果
   - 收集所有可视化视频
   - 如果有GT，计算MPJPE、PA-MPJPE
   - 生成初步报告

**产出**: UniEgoMotion在EE4D上的完整评估报告

### 第二步：环境准备（需要更多时间）

🔧 **解决EgoAllo环境**

1. 尝试在独立环境安装EgoAllo
   - 可能需要Docker
   - 或者使用服务器/集群

2. 如果成功，进行方案B的完整对比

3. 如果失败，考虑：
   - 联系EgoAllo作者寻求帮助
   - 仅用UniEgoMotion结果（也是有价值的）

---

## 📝 当前可执行任务

我现在可以帮你：

### 选项1：UniEgoMotion批量评估
创建脚本同时运行多个序列，整理结果

### 选项2：准备EgoAllo适配器
编写代码框架，等环境就绪后直接使用

### 选项3：指标计算工具
即使没有EgoAllo结果，也可以先开发评估工具

### 选项4：文档完善
整理更详细的使用指南和技术文档

---

## ❓你的决定

请告诉我你希望：

**A. 立即行动** - 先把UniEgoMotion的评估做完整（推荐）

**B. 继续EgoAllo** - 我帮你解决环境问题或创建适配器

**C. 两步并行** - 在解决环境的同时，先做UniEgoMotion评估

**D. 其他想法** - 你有不同的优先级

我会根据你的选择继续推进工作！
