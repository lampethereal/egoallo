# EgoAllo 一键推理使用指南

## 快速开始

由于EgoAllo在AMASS数据集上训练，使用EE4D数据集需要特殊处理。本文档提供完整的使用流程。

## 环境要求

EgoAllo需要较新的Python环境和特殊依赖：

```bash
# EgoAllo要求
Python >= 3.12
PyTorch
JAX (用于guidance优化)
ProjectAria工具 (用于Aria数据)

# 由于ProjectAria工具安装复杂，我们提供了简化方案
```

## 核心挑战

### 1. 数据格式差异

| 特性 | EE4D/UniEgoMotion | EgoAllo |
|------|-------------------|---------|
| 输入长度 | T帧 | T+1帧 |
| 旋转表示 | rotation_6d [6] | 四元数 wxyz [4] |
| 数据维度 | [T, 9] | [T+1, 7] |
| SMPL版本 | SMPL-X | SMPL-H |
| 采样频率 | 10 FPS | 30 FPS |
| 窗口大小 | 80帧（8秒） | 128帧（4.27秒） |

### 2. 输入要求差异

**UniEgoMotion**:
- 只需要头部轨迹
- 可选图像特征（DINOv2）

**EgoAllo**:
- 必需头部轨迹
- 训练时不用图像
- 推理时可选手部检测（HaMeR）用于guidance优化

### 3. 评估策略

由于数据格式和架构差异，直接对比需要：
1. 统一采样频率（都用10 FPS或30 FPS）
2. 统一窗口大小
3. 统一SMPL关节点定义
4. 对齐坐标系

## 推荐的对比方案

### 方案A：使用UniEgoMotion的配置（推荐）

**优点**: EE4D数据集原生10 FPS，UniEgoMotion已经优化

**步骤**:
1. 保持EE4D数据10 FPS
2. EgoAllo推理时降采样到10 FPS
3. 都使用80帧窗口
4. 转换SMPL-H到SMPL-X（或统一评估关节）

### 方案B：上采样到30 FPS

**优点**: 发挥EgoAllo的最佳性能

**步骤**:
1. 对EE4D轨迹插值到30 FPS
2. EgoAllo使用128帧窗口（4.27秒）
3. UniEgoMotion使用对应时长

## 实施计划

考虑到复杂度，我建议分阶段进行：

### 阶段1: 简化对比（当前可行）

**目标**: 快速验证两个模型在相同数据上的表现

**实施**:
```python
# 1. 使用UniEgoMotion推理（已完成）
python 一键推理.py --sequence "indiana_cooking_23_5___0___513"
# 输出: SMPL-X参数, 可视化视频

# 2. 手动转换数据给EgoAllo
#    - 提取aria_traj [80, 9]
#    - 转换为Ts_world_cpf [81, 7]
#    - 保存为临时文件

# 3. 修改EgoAllo代码以接受转换后的数据
#    - 绕过VRS/MPS加载
#    - 直接使用转换后的Ts_world_cpf

# 4. 评估：
#    - 转换两个模型的输出到统一格式
#    - 计算3D关键点误差（MPJPE）
```

### 阶段2: 完整pipeline（需要更多工作）

创建统一的评估框架，自动处理所有转换。

## 当前可执行方案

鉴于环境和依赖的复杂性，我先为你创建以下工具：

### 1. 数据转换脚本 ✓

`ee4d_to_egoallo_简化版.py` - 纯PyTorch实现，不需要ProjectAria

### 2. UniEgoMotion批量推理 ✓

已有 `一键推理.py`

### 3. 结果对比脚本（下一步）

处理两个模型的输出，生成对比报告

## 建议行动

**现在立即可以做的**:

1. 使用UniEgoMotion推理几条EE4D数据 ✓
2. 手动查看结果质量 ✓
3. 准备数据转换工具 ✓

**需要更多时间的**:

1. 完整安装EgoAllo环境（ProjectAria工具）
2. 修改EgoAllo代码以支持EE4D数据
3. 实现自动化对比流程

## 下一步行动建议

我建议采用**务实的方法**：

1. **先验证UniEgoMotion** ✓
   - 在多条EE4D数据上测试
   - 生成定性结果（视频）
   - 如果有GT，计算定量指标

2. **准备EgoAllo环境**
   - 在干净的Python 3.12+环境中安装
   - 测试EgoAllo的example数据
   - 确认模型可以正常运行

3. **数据适配**
   - 创建EE4D数据的"伪Aria格式"
   - 最小化修改EgoAllo代码

4. **对比评估**
   - 统一输出格式
   - 计算对比指标

这样可以确保稳步推进，避免卡在依赖问题上。

你希望我：
A) 继续完善数据转换工具（纯Python，当前环境可用）
B) 创建EgoAllo的简化推理接口（需要新环境）
C) 先专注于UniEgoMotion的完整评估和可视化
